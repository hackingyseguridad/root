#!/bin/bash

# Derechos de autor (c) 2021 Red Hat, Inc.
#
# Este programa es software libre: puedes redistribuirlo y/o modificarlo
# bajo los términos de la Licencia Pública General GNU publicada por
# la Free Software Foundation, ya sea la versión 3 de la Licencia, o
# (a su elección) cualquier versión posterior.

VERSIÓN="1.0"

¡Advertencia! Asegúrese de descargar la última versión de este script desde su fuente principal:

BOLETÍN="https://access.redhat.com/security/vulnerabilities/RHSB-2021-002"

# ¡NO confíe ciegamente en ninguna fuente de Internet y NUNCA haga `curl something | bash`!

Este script está diseñado para la detección simple de la vulnerabilidad. Puede modificarlo según sus necesidades.
# entorno o necesidades. Para una detección más avanzada, considere Red Hat Insights:
# https://access.redhat.com/products/red-hat-insights#getstarted

# Es necesario verificar la lista de paquetes vulnerables debido a la forma en que se ejecutan las funciones.
# se trasladan a versiones anteriores de paquetes en varios canales.


VERSIONES VULNERABLES=(
    'sudo-1.8.6p7-13.ael7b'
    'sudo-1.6.8p12-12.el5'
    'sudo-1.6.9p17-3.el5'
    'sudo-1.6.9p17-3.el5_3.1'
    'sudo-1.6.9p17-5.el5'
    'sudo-1.6.9p17-6.el5_4'
    'sudo-1.7.2p1-5.el5'
    'sudo-1.7.2p1-6.el5_5'
    'sudo-1.7.2p1-7.el5_5'
    'sudo-1.7.2p1-8.el5_5'
    'sudo-1.7.2p1-9.el5_5'
    'sudo-1.7.2p1-10.el5'
    'sudo-1.7.2p1-13.el5'
    'sudo-1.7.2p1-14.el5_8.2'
    'sudo-1.7.2p1-14.el5_8.3'
    'sudo-1.7.2p1-14.el5_8.4'
    'sudo-1.7.2p1-14.el5_8'
    'sudo-1.7.2p1-19.el5'
    'sudo-1.7.2p1-22.el5'
    'sudo-1.7.2p1-22.el5_9.1'
    'sudo-1.7.2p1-28.el5'
    'sudo-1.7.2p1-29.el5_10'
    'sudo-1.7.2p1-30.el5_11'
    'sudo-1.7.2p1-31.el5_11.1'
    'sudo-1.7.2p1-31.el5_11'
    'sudo-1.7.2p2-9.el6'
    'sudo-1.7.4p5-5.el6'
    'sudo-1.7.4p5-6.el6_1'
    'sudo-1.7.4p5-7.el6'
    'sudo-1.7.4p5-9.el6_2'
    'sudo-1.7.4p5-11.el6'
    'sudo-1.7.4p5-12.el6_3'
    'sudo-1.7.4p5-13.el6_3.1'
    'sudo-1.7.4p5-13.el6_3'
    'sudo-1.8.6p3-7.el6'
    'sudo-1.8.6p3-12.el6'
    'sudo-1.8.6p3-12.el6_5.2'
    'sudo-1.8.6p3-15.el6'
    'sudo-1.8.6p3-15.el6_6.2'
    'sudo-1.8.6p3-19.el6'
    'sudo-1.8.6p3-20.el6_7'
    'sudo-1.8.6p3-24.el6'
    'sudo-1.8.6p3-25.el6_8'
    'sudo-1.8.6p3-27.el6'
    'sudo-1.8.6p3-28.el6_9'
    'sudo-1.8.6p3-29.el6_9'
    'sudo-1.8.6p3-29.el6_10.2'
    'sudo-1.8.6p3-29.el6_10.3'
    'sudo-1.8.6p7-7.el7'
    'sudo-1.8.6p7-11.el7'
    'sudo-1.8.6p7-13.el7'
    'sudo-1.8.6p7-16.el7'
    'sudo-1.8.6p7-17.el7_2.2'
    'sudo-1.8.6p7-17.el7_2'
    'sudo-1.8.6p7-20.el7'
    'sudo-1.8.6p7-21.el7_3'
    'sudo-1.8.6p7-22.el7_3'
    'sudo-1.8.6p7-23.el7_3.2'
    'sudo-1.8.6p7-23.el7_3'
    'sudo-1.8.19p2-10.el7'
    'sudo-1.8.19p2-11.el7_4'
    'sudo-1.8.19p2-12.el7_4.1'
    'sudo-1.8.19p2-12.el7_4'
    'sudo-1.8.19p2-13.el7'
    'sudo-1.8.19p2-14.el7_5.1'
    'sudo-1.8.19p2-14.el7_5'
    'sudo-1.8.23-1.el7'
    'sudo-1.8.23-3.el7'
    'sudo-1.8.23-3.el7_6.1'
    'sudo-1.8.23-4.el7'
    'sudo-1.8.23-4.el7_7.1'
    'sudo-1.8.23-4.el7_7.2'
    'sudo-1.8.23-9.el7'
    'sudo-1.8.23-10.el7'
    'sudo-1.8.25p1-4.el8'
    'sudo-1.8.25p1-4.el8_0.1'
    'sudo-1.8.25p1-4.el8_0.2'
    'sudo-1.8.25p1-4.el8_0.3'
    'sudo-1.8.25p1-7.el8'
    'sudo-1.8.25p1-8.el8_1.1'
    'sudo-1.8.25p1-8.el8_1'
    'sudo-1.8.29-5.el8'
    'sudo-1.8.29-6.el8'
    'sudo-1.6.7p5-30.1.1'
    'sudo-1.6.7p5-30.1.3'
    'sudo-1.6.7p5-30.1.5'
    'sudo-1.6.7p5-30.1'
    'sudo-1.6.8p12-10'
)


obtener_paquetes_instalados() {
    # Comprueba los paquetes instalados. Compatible con RHEL5.
    #
    # Argumentos:
    # package_names - una matriz de cadenas de nombres de paquetes
    #
    # Impresiones:
    # Líneas con cadenas NVR.A de los paquetes instalados.

    nombres_de_paquetes locales=( "$@" )

    rpm -qa --queryformat="%{NOMBRE}-%{VERSIÓN}-%{RELEASE}.%{ARCH}\n" "${nombres_de_paquete[@]}"
}


comprobar_paquete() {
    # Comprueba si el paquete instalado está en la lista de paquetes vulnerables.
    #
    # Argumentos:
    # installed_packages - cadena de paquetes instalados tal como la devuelve 'rpm -qa package'
    # (puede ser multilineal)
    # vulnerable_versions - una matriz de versiones vulnerables
    #
    # Impresiones:
    # Primera cadena de paquete vulnerable devuelta por 'rpm -qa package', o nada

    # Convertir a matriz, usar división de palabras a propósito
    # shellcheck deshabilitado=SC2206
    paquetes_instalados_locales=( $1 )
    cambio
    versiones vulnerables locales=( "$@" )

    para el paquete probado en "${vulnerable_versions[@]}"; hacer
        para paquete_instalado en "${paquetes_instalados[@]}"; hacer
            paquete_instalado_sin_arquitectura="${paquete_instalado%.*}"
            si [[ "$paquete_instalado_sin_arquitectura" == "$paquete_probado" ]]; entonces
                echo "$paquete_instalado"
                devolver 0
            ser
        hecho
    hecho
}


argumentos_básicos() {
    # Analiza los argumentos básicos de la línea de comandos y establece el entorno básico.
    #
    # Argumentos:
    # parámetros: una matriz de argumentos de línea de comandos
    #
    # Efectos secundarios:
    # Sale si se utilizan los parámetros --help
    # Establece constantes de COLOR y variables de depuración

    parámetros locales=( "$@" )

    ROJO="\\033[1;31m"
    VERDE="\\033[1;32m"
    NEGRITA="\\033[1m"
    REINICIAR="\\033[0m"
    para el parámetro en "${parameters[@]}"; hacer
        si [[ "$parámetro" == "-h" || "$parámetro" == "--help" ]]; entonces
            echo "Uso: $(nombre base "$0" ) [-n | --no-colors] [-d | --debug]"
            salida 1
        elif [[ "$parámetro" == "-n" || "$parámetro" == "--no-colors" ]]; entonces
            ROJO=""
            VERDE=""
            NEGRITA=""
            REINICIAR=""
        elif [[ "$parámetro" == "-d" || "$parámetro" == "--debug" ]]; entonces
            depuración=verdadero
        ser
    hecho
}


requisitos_básicos() {
    # Imprime la exención de responsabilidad común y verifica los requisitos básicos.
    #
    # Argumentos:
    # CVE - cadena impresa en el descargo de responsabilidad
    #
    # Efectos secundarios:
    # Sale cuando el comando 'rpm' no está disponible

    CVE local="$1"

    # Descargo de responsabilidad
    eco
    echo -e "${BOLD}Este script (v$VERSION) está diseñado principalmente para detectar $CVE en versiones compatibles"
    echo -e "Sistemas Red Hat Enterprise Linux y paquetes de kernel".
    echo -e "El resultado puede ser inexacto para otros sistemas basados ​​en RPM.${RESET}"
    eco

    # Se requieren RPM
    si ! comando -v rpm &> /dev/null; entonces
        echo "Se requiere el comando 'rpm', pero no está instalado. Saliendo."
        salida 1
    ser
}


comprobar_kernel_compatible() {
    # Comprueba si el kernel en ejecución es compatible.
    #
    # Argumentos:
    # running_kernel - cadena de kernel tal como la devuelve 'uname -r'
    #
    # Efectos secundarios:
    # Sale cuando el kernel en ejecución obviamente no es compatible

    núcleo_en_ejecución_local="$1"

    # Verificar plataforma compatible
    si [[ "$running_kernel" != *".el"[6-8]* ]]; entonces
        echo -e "${RED}Este script está destinado a usarse únicamente en RHEL 6-8.${RESET}"
        salida 1
    ser
}


obtener_rhel() {
    # Obtiene el número RHEL.
    #
    # Argumentos:
    # running_kernel - cadena de kernel tal como la devuelve 'uname -r'
    #
    # Impresiones:
    # Número RHEL, por ejemplo, '5', '6', '7' o '8'

    núcleo_en_ejecución_local="$1"

    rhel local
    rhel=$( sed -r -n 's/^.*el([[:digit:]]).*$/\1/p' <<< "$núcleo_en_ejecución" )
    echo "$rhel"
}


establecer_valores_predeterminados() {
    resultado=0
}


analizar_hechos() {
    # Recopila toda la información disponible y la almacena en variables globales. Solo almacena datos y
    # No saque conclusiones en esta función para una mejor mantenibilidad.
    #
    # Efectos secundarios:
    # Establece muchos indicadores booleanos globales y variables de contenido

    resultado_paquetes_instalados=$( obtener_paquetes_instalados "sudo" )
}


sacar_conclusiones() {
    # Extrae conclusiones basadas en los datos del sistema disponibles.
    #
    # Efectos secundarios:
    # Establece muchos indicadores booleanos globales y variables de contenido

    paquete_vulnerable=$( paquete_de_comprobación "$paquetes_instalados_resultados" "${VERSIONES_VULNERABLES[@]}" )

    si [[ "$paquete_vulnerable" ]]; entonces
        resultado=1
    ser
}


depuración_impresión() {
    # Imprime las variables seleccionadas cuando la depuración está habilitada.

    variables=( núcleo_en_ejecución rhel resultado_paquetes_instalados paquete_vulnerable resultado )
    para variable en "${variables[@]}"; hacer
        echo "$variable = *${!variable}*"
    hecho
    eco
}


si [[ "${BASH_SOURCE[0]}" == "$0" ]]; entonces
    argumentos_básicos "$@"
    Requisitos básicos "CVE-2021-3156"
    núcleo_en_ejecución=$( uname -r )
    check_supported_kernel "$núcleo_en_ejecución"

    rhel=$( get_rhel "$núcleo_en_ejecución" )

    establecer_valores_predeterminados
    analizar_hechos
    sacar conclusiones

    # Impresiones de depuración
    si [[ "$debug" ]]; entonces
        impresión de depuración
    ser

    si [[ ! "$result_installed_packages" ]]; entonces
        echo -e "${GREEN}'sudo' no está instalado${RESET}."
        salida 0
    ser

    # Resultados
    echo -e "Paquete 'sudo' detectado: ${BOLD}$result_installed_packages${RESET}"
    si (( resultado )); entonces
        echo -e "${RED}Esta versión de sudo es vulnerable.${RESET}"
        echo -e "Siga a $BULLETIN para obtener consejos".
    demás
        echo -e "${GREEN}Esta versión de sudo no es vulnerable.${RESET}"
    ser

    salir "$resultado"
ser
